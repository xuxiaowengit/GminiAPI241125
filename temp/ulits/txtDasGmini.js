const fileProcessor=require("./plugins/readyNtxt.js"),directoryPath="./dataIn/待处理TXT",moveFile=require("./plugins/removeFile.js"),fs=require("fs"),qusetionRes=require("./qusetionTxt.js").qusetionRes,moment=require("moment"),path=require("path"),generateLog=require("./plugins/logger.js"),logFilePath=path.join(__dirname,"./log/appRun.log"),message="This is  system log,下面是本次系统运行日志：",generateContent=(generateLog(logFilePath,message),require("./Gmini.js")),moveFiles=require("./plugins/fileMover.js"),sourceDir="./outExe/GminiResData",targetDir="./outExe/lastRunDataBackup";moveFiles(sourceDir,targetDir).then((()=>{console.log("所有文件成功移动到目标目录")})).catch((r=>{console.error("发生错误:",r)}));var filterString=require("./plugins/filterString.js");const{createExcelFile:createExcelFile,appendToExcel:appendToExcel}=require("./outFile.js");var resData=[],resError=[],resOther=[];function delay(r){return console.log("延时",r,"毫秒"),new Promise((e=>setTimeout(e,r)))}var readyTxtName="";const destDir="outExe/GminiResData/";let currentDateTime=moment().format("MM-DD HH-mm-ss");const errTxtPath=path.join(destDir,"移出的TXT-"+currentDateTime);fs.mkdir(errTxtPath,{recursive:!0},(r=>{if(r)return console.error("Failed to create directory: "+r.message);console.log("Directory created successfully!")}));var arrryStr=[],arrryStr2=[],arrryStr3=[];async function processTxtFiles(r){var e;r=1;try{do{if(e=await fileProcessor.getNewTxtFilePath(directoryPath),console.log("filePath:",e),""!==e&&null!==e){var t=await qusetionRes(),a=await fileProcessor.readFileContent(e,r),o='"'+a.data+'"'+t;try{var s,l,i,n,m,h,g,u,y,c=await generateContent(o),S=JSON.stringify(c);""!=c&&null!=c&&"error"!=c.reqStatus&&"ErrorResponse"!=c.reqStatus&&"ErrorRequest"!=c.reqStatus&&"ErrorMessage"!=c.reqStatus&&"接口请求未成功！请检查地址或网络!"!==c.apiError&&0<c.parts.length?(s=JSON.stringify(c.parts[0].text),l=c.parts[0].text,i=filterString.filter(l),console.log("分析结果:",i,",返回TXT:",s),console.log("API返回:",S),0<c.parts.length?""!==c.parts[0].text&&null!==c.parts[0].text&&void 0!==c.parts[0].text?"Y111"==i?(arrryStr.push(a.email),arrryStr.push("GminiChatV1.5"),arrryStr.push(i),n=moment().format("MM-DD HH:mm:ss"),arrryStr.push(n),resData.push(arrryStr),console.log("arrryStr:",arrryStr),arrryStr=[]):"N000"==i?(arrryStr2.push(a.email),arrryStr2.push("GminiChatV1.5"),arrryStr2.push(i),m=moment().format("MM-DD HH:mm:ss"),arrryStr2.push(m),resError.push(arrryStr2),console.log("arrryStr2:",arrryStr2),arrryStr2=[]):(arrryStr3.push(a.email),arrryStr3.push("GminiChatV1.5"),arrryStr3.push("NOT! 0 OR 1 ,"+S),h=moment().format("MM-DD HH:mm:ss"),arrryStr3.push(h),moveFile(e,errTxtPath,((r,e)=>{r?console.error("Error moving file:",r):console.log("失败的txt挪出完成!",e)})),resOther.push(arrryStr3),console.log("arrryStr3-1:",arrryStr3),arrryStr3=[]):(readyTxtName=e,console.log("第",r,"个,",c.parts.length),arrryStr3.push(a.email),arrryStr3.push("GminiChatV1.5"),arrryStr3.push("返回数据异常,"+S),generateLog(logFilePath,"API返回数据异常:"+a.email),g=moment().format("MM-DD HH:mm:ss"),arrryStr3.push(g),moveFile(e,errTxtPath,((r,e)=>{r?console.error("Error moving file:",r):console.log("失败的txt挪出完成！",e)})),resOther.push(arrryStr3),console.log("arrryStr3-2:",arrryStr3),arrryStr3=[]):(readyTxtName=e,arrryStr3.push(a.email),arrryStr3.push("GminiChatV1.5"),arrryStr3.push("返回数据格式不匹配,"),console.log("第",r,"个文本数据chatAPI返回异常:",arrryStr),generateLog(logFilePath,"第"+r+"个文件分析"),u=moment().format("MM-DD HH:mm:ss"),arrryStr3.push(u),moveFile(e,errTxtPath,((r,e)=>{r?console.error("Error moving file:",r):console.log("失败的txt挪出完成！",e)})),resOther.push(arrryStr3),console.log("arrryStr3-3:",arrryStr3),arrryStr3=[])):(readyTxtName=e,arrryStr3.push(a.email),arrryStr3.push("GminiChatV1.5"),arrryStr3.push("返回数据为空！,"),y=moment().format("MM-DD HH:mm:ss"),arrryStr3.push(y),console.log("第",r,"个文本分析异常,chatAPI返回无效格式或接口不存在!",JSON.stringify(c)),generateLog(logFilePath,"result为空:"+JSON.stringify(c)),moveFile(e,errTxtPath,((r,e)=>{r?console.error("Error moving file:",r):console.log("失败的txt挪出完成！",e)})),resOther.push(arrryStr3),console.log("arrryStr3-4:",arrryStr3),arrryStr3=[])}catch(t){readyTxtName=e,console.log("第",r,"个文本处理过程中出现异常，导致中断退出！",t),arrryStr3.push(a.email),arrryStr3.push("GminiChatV1.5"),arrryStr3.push("处理过程中出现异常错误导致循环中断！,");var p=moment().format("MM-DD HH:mm:ss");arrryStr3.push(p),generateLog(logFilePath,t),moveFile(e,errTxtPath,((r,e)=>{r?console.error("Error moving file:",r):console.log("失败的txt挪出完成！",e)})),resOther.push(arrryStr3),console.log("arrryStr3-5:",arrryStr3),arrryStr3=[]}finally{console.log("完成第",r,"个TXT文件处理,模型是:","GminiChatV1.5"),arrryStr=[],arrryStr2=[],arrryStr3=[],r++}}else readyTxtName=e,console.log("TXT文件内容为空或已处理完！"),generateLog(logFilePath,"文件处理完！共计:"+(r-1)+"个。")}while(await delay(3e3),e);var x=moment().format("MM-DD HH-mm-ss");console.log("resData:",resData),console.log("resError:",resError),console.log("resOther:",resOther),0<resData.length&&createExcelFile(resData,"./outExe/GminiResData/为1的-"+x+".xlsx","sheet1"),0<resError.length&&createExcelFile(resError,"./outExe/GminiResData/为0的-"+x+".xlsx","sheet1"),0<resOther.length&&createExcelFile(resOther,"./outExe/GminiResData/非1或0&Error-"+x+".xlsx","sheet1"),generateLog(logFilePath,"完成全部"+(r-1)+"个文本数据处理！并保存了全部数据！")}catch(t){console.error("An error occurred:",t),generateLog(logFilePath,t)}}processTxtFiles();