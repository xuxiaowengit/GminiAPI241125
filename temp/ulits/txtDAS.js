const fileProcessor=require("./readyNtxt.js"),directoryPath="./dataIn/待处理TXT",interactWithChatGPT=require("./chatAPI");var qusetion=require("./qusetionTxt.js");const moment=require("moment"),generateLog=require("./logger"),path=require("path"),logFilePath=path.join(__dirname,"./log/appRun.log"),message="This is  system log,下面是本次系统日志：";generateLog(logFilePath,message);const generateContent=require("./Gmini.js"),{appendToExcel:appendToExcel}=require("./outFile"),apiKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6Ijk1YTBlMjIzLWQ0ZGYtNGFkNC1iZjBlLTA3OWIyMTUxYmU5YiJ9.S95yOdHFmevutvd7_w81hBJjA2kKlnAQCdG0b7VwW7s",modelEndpoint="http://192.168.1.254:11434/v1/chat/completions",modelName="openchat:7b-v3.5-1210";var resData=[];async function processFileContent(e,o){return new Promise(((t,a)=>{setTimeout((()=>{var i=e.data+qusetion.qusetion;interactWithChatGPT(i,apiKey,modelEndpoint,modelName).then((a=>{generateLog(logFilePath,"完成第"+o+"次文本分析请求:"+e.email),t(a)})).catch((e=>{milliseconds=today.getMilliseconds(),generateLog(logFilePath,"Error interacting with openChatAPI"+e),console.log("chatAPI接口未响应或不存在！"),a(e)}))}),10)}))}async function processTxtFiles(e){e=1;try{let t;do{t=await fileProcessor.getNewTxtFilePath(directoryPath),console.log("filePath",t);var o=[];if(""!==t){const a=await fileProcessor.readFileContent(t,e),i=await processFileContent(a,e);o.push(a.email),o.push(modelName),""!=i.choices&&"TypeError: fetch failed"!=typeof i?i.choices.length>0&&""!=i.choices?(console.log("分析结果:",i.choices[0].message),o.push(i.choices[0].message.content),console.log("完成第"+e+"个文本数据处理,模型是:"+modelName+"--"+modelEndpoint),generateLog(logFilePath,"完成第"+e+"个文本数据处理,模型是:"+modelName+"--"+modelEndpoint)):(generateLog(logFilePath,"文本chatAPI分析异常:"+a.email),console.log("第"+e+"个文本数据chatAPI处理异常!"),o.push("chatAPI返回无效格式")):(console.log("第"+e+"个文本分析异常,chatAPI返回无效格式或接口不存在!"),console.log("apiResult:",i),o.push("chatAPI请求失败"),generateLog(logFilePath,"chatAPI返回无效格式或接口不存在"));let l=moment().format("MM-DD HH:mm:ss");o.push(l)}else console.log("全部处理完毕，共计:",e);e++,resData.push(o)}while(t);let a=moment().format("MM-DD HH:mm");appendToExcel("./outExe/纯文本数据分析结果-OpenAiV3.5.xlsx",a,resData),generateLog(logFilePath,"完成全部"+e+"个文本数据处理！并保存了全部数据！")}catch(e){console.error("An error occurred:",e),generateLog(logFilePath,e)}}processTxtFiles();