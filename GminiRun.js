const fileProcessor=require("./plugins/readyNtxt.js"),directoryPath="./dataIn/待处理TXT",moveFile=require("./plugins/removeFile.js"),fs=require("fs"),path=require("path"),{qusetionRes:qusetionRes}=require("./plugins/qusetionTxt.js"),moment=require("moment"),filterString=require("./plugins/filterString.js"),generateLog=require("./plugins/logger.js"),logFilePath=path.join(__dirname,"./log/appRun.log"),message="This is system log,下面是本次系统运行日志：";generateLog(logFilePath,message);const generateContent=require("./api/Gmini.js"),moveFiles=require("./plugins/fileMover.js"),sourceDir="./outExe/GminiResData",targetDir="./outExe/lastRunDataBackup";moveFiles(sourceDir,targetDir).then((()=>{console.log("数据备份完成")})).catch((r=>{console.error("数据备份失败:",r)}));const{createExcelFile:createExcelFile,appendToExcel:appendToExcel}=require("./plugins/outFile.js");var resData=[],resError=[],resOther=[];function delay(r){return console.log("延时",r,"毫秒"),new Promise((e=>setTimeout(e,r)))}var readyTxtName="";const destDir="outExe/GminiResData/";let currentDateTime=moment().format("MM-DD HH-mm-ss");const errTxtPath=path.join(destDir,"移出的TXT-"+currentDateTime);var arrryStr=[],arrryStr2=[],arrryStr3=[];async function processTxtFiles(r=0){r=1;try{let a;do{if(a=await fileProcessor.getNewTxtFilePath(directoryPath),""!==a&&null!==a){console.log("filePath:",a);const i=await qusetionRes(),n=await fileProcessor.readFileContent(a,r);var e='"'+n.data+'"'+i,t="";try{const i=await generateContent(e);if(t=JSON.stringify(i),""!==i&&null!==i&&"error"!==i.reqStatus&&"ErrorResponse"!==i.reqStatus&&"ErrorRequest"!==i.reqStatus&&"ErrorMessage"!==i.reqStatus&&"接口请求未成功！请检查地址或网络!"!==i.apiError&&i.parts.length>0){JSON.stringify(i.parts[0].text);var s=i.parts[0].text,o=filterString.filter(s);if(console.log("API返回:",t),i.parts.length>0)if(""!==i.parts[0].text&&null!==i.parts[0].text&&void 0!==i.parts[0].text)if("Y111"==o){arrryStr.push(n.email),arrryStr.push("GminiChatV1.5"),arrryStr.push(o);let r=moment().format("MM-DD HH:mm:ss");arrryStr.push(r),resData.push(arrryStr),console.log("arrryStr:",arrryStr),arrryStr=[]}else if("N000"==o){arrryStr2.push(n.email),arrryStr2.push("GminiChatV1.5"),arrryStr2.push(o);let r=moment().format("MM-DD HH:mm:ss");arrryStr2.push(r),resError.push(arrryStr2),console.log("arrryStr2:",arrryStr2),arrryStr2=[]}else{arrryStr3.push(n.email),arrryStr3.push("GminiChatV1.5"),arrryStr3.push("NOT! 0 OR 1 ,"),arrryStr3.push(t);let r=moment().format("MM-DD HH:mm:ss");arrryStr3.push(r),moveFile(a,errTxtPath,((r,e)=>{r?console.error("Error moving file:",r):console.log("失败的txt挪出完成!",e)})),resOther.push(arrryStr3),arrryStr3=[]}else console.log("第",r,"个,",i.parts.length),arrryStr3.push(n.email),arrryStr3.push("GminiChatV1.5"),arrryStr3.push("返回数据异常,"+t),generateLog(logFilePath,"API返回数据异常:"+n.email),arrryStr3.push(l),arrryStr3.push(i),moveFile(a,errTxtPath,((r,e)=>{r?console.error("Error moving file:",r):console.log("失败的txt挪出完成！",e)})),resOther.push(arrryStr3),arrryStr3=[];else{arrryStr3.push(n.email),arrryStr3.push("GminiChatV1.5"),arrryStr3.push("返回数据格式不匹配,"),console.log("第",r,"个文本数据chatAPI返回异常:",arrryStr),generateLog(logFilePath,"第"+r+"个文件分析");let e=moment().format("MM-DD HH:mm:ss");arrryStr3.push(JSON.stringify(i)),arrryStr3.push(e),moveFile(a,errTxtPath,((r,e)=>{r?console.error("Error moving file:",r):console.log("失败的txt挪出完成！",e)})),resOther.push(arrryStr3),console.log("arrryStr3-3:",arrryStr3),arrryStr3=[]}}else{arrryStr3.push(n.email),arrryStr3.push("GminiChatV1.5"),(i.error.error.code=400)?arrryStr3.push(i.error.error.message):arrryStr3.push("返回数据为空！,"),arrryStr3.push(JSON.stringify(i));let e=moment().format("MM-DD HH:mm:ss");arrryStr3.push(e),console.log("第",r,"个文本分析异常,chatAPI返回无效格式或接口不存在!",JSON.stringify(i)),generateLog(logFilePath,"result为空:"+JSON.stringify(i)),moveFile(a,errTxtPath,((r,e)=>{r?console.error("Error moving file:",r):console.log("失败的txt挪出完成！",e)})),resOther.push(arrryStr3),arrryStr3=[]}}catch(e){console.log("第",r,"API请求连接过程中出现异常，导致中断退出！",e),arrryStr3.push("异常错误导致循环中断！"),arrryStr3.push(e.stack||e.message);let t=moment().format("MM-DD HH:mm:ss");arrryStr3.push(t),generateLog(logFilePath,e),moveFile(a,errTxtPath,((r,e)=>{r?console.error("Error moving file:",r):console.log("失败的txt挪出完成！",e)}));const s=arrryStr3.map((r=>"string"==typeof r?r:JSON.stringify(r)));resOther.push(s),console.log("arrryStr3-5:",s)}finally{console.log("完成第",r,"个TXT文件处理,模型是:","GminiChatV1.5"),arrryStr=[],arrryStr2=[],arrryStr3=[],r++}}else console.log("TXT文件内容为空或已处理完！"),generateLog(logFilePath,"文件处理完！共计:"+(r-1)+"个。");await delay(3e3)}while(a);let l=moment().format("MM-DD HH-mm-ss");console.log("Y111:",resData.length),console.log("N000:",resError.length),console.log("Not1/0:",resOther.length),resData.length>0&&createExcelFile(resData,"./outExe/GminiResData/为1的-"+l+".xlsx","sheet1"),resError.length>0&&createExcelFile(resError,"./outExe/GminiResData/为0的-"+l+".xlsx","sheet1"),resOther.length>0&&createExcelFile(resOther,"./outExe/GminiResData/非1或0&Error-"+l+".xlsx","sheet1"),generateLog(logFilePath,"完成全部"+(r-1)+"个文本数据处理！并保存了全部数据！")}catch(r){console.error("An error occurred:",r),generateLog(logFilePath,r)}}async function handleResult(r,e,t,s){const o=moment().format("MM-DD HH:mm:ss");let a=[];if(""!==e.parts[0].text&&null!==e.parts[0].text){const s=filterString.filter(e.parts[0].text);a.push(r.email,"GminiChatV1.5",s,o),"Y111"===s?resData.push(a):"N000"===s?resError.push(a):(a[2]="NOT! 0 OR 1 ,"+t,moveFile(filePath,errTxtPath,((r,e)=>{r?console.error("Error moving file:",r):console.log("失败的txt挪出完成!",e)})),resOther.push(a))}}processTxtFiles();